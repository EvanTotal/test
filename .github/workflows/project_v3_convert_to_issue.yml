name: Inherit Labels, Assignees & Status from Project V2 Row

on:
  issues:
    types: [opened]

permissions:
  issues: write
  repository-projects: write
  contents: read

jobs:
  inherit_metadata:
    runs-on: ubuntu-latest
    steps:
      - name: Inherit metadata from Project V2
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # PAT with repo + project scopes
          script: |
            const issueNumber = context.payload.issue.number;
            const issueNodeId = context.payload.issue.node_id;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // ðŸ”‘ Use your actual Project V2 ID
            const projectId = "PVT_kwHODd007c4BEBb_"; // <-- replace with your real project ID

            // GraphQL query to fetch items + field values
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field { name }
                              text
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field { name }
                              name
                            }
                            ... on ProjectV2ItemFieldUserValue {
                              field { name }
                              users(first: 5) {
                                nodes { login }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(query, { projectId });

            // Find this issueâ€™s row in the project
            const row = projectData.node.items.nodes.find(
              n => n.content && n.content.id === issueNodeId
            );
            if (!row) {
              console.log("âŒ No matching Project V2 row found. Exiting.");
              return;
            }

            let labelsFromProject = [];
            let assigneesFromProject = [];

            for (const fieldNode of row.fieldValues.nodes) {
              const fieldName = fieldNode.field.name;

              // ðŸ·ï¸ Labels field
              if (fieldName === "Labels") {
                if (fieldNode.text) {
                  labelsFromProject = fieldNode.text.split(",").map(s => s.trim());
                } else if (fieldNode.name) {
                  labelsFromProject.push(fieldNode.name);
                }
              }

              // ðŸ‘¤ Assignees field
              if (fieldName === "Assignees" && fieldNode.users) {
                assigneesFromProject = fieldNode.users.nodes.map(u => u.login);
              }

              // ðŸ“Œ Status field â†’ convert into label
              if (fieldName === "Status" && fieldNode.name) {
                labelsFromProject.push(`Status: ${fieldNode.name}`);
              }
            }

            console.log("Labels to add:", labelsFromProject);
            console.log("Assignees to add:", assigneesFromProject);

            // Apply labels
            if (labelsFromProject.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: labelsFromProject
              });
            }

            // Apply assignees
            if (assigneesFromProject.length > 0) {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issueNumber,
                assignees: assigneesFromProject
              });
            }

            console.log("âœ… Metadata (Labels, Assignees, Status) inherited!");
